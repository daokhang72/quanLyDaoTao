<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Page</title>
    <style>
        body{
          margin: 0;
        }
        .container {
          display: flex;
          height: 100vh;
        }

        .sidebar {
          width: 250px;
          background-color: #ffe55c;
          border-right: 2px solid #0097ff;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .profile {
          padding: 20px 0;
          text-align: center;
        }

        .profile img {
          border-radius: 50%;
          width: 80px;
          height: 80px;
        }

        .profile h3 {
          margin-top: 10px;
          font-size: 18px;
        }

        .menu {
          width: 100%;
        }

        .menu a {
          display: block;
          padding: 12px 20px;
          text-decoration: none;
          color: black;
          border-top: 1px solid #ddd;
        }

        .menu a.active {
          background-color: white;
          font-weight: bold;
        }

        .menu a:hover {
          background-color: #fdd835;
        }

        .content {
          flex: 1;
          background-color: #f7f7f7;
          padding: 40px;
          text-align: center;
        }
        /*content*/
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .search-container {
          display: flex;
          justify-content: center;
          align-items: center;
          margin: 20px 0;
        }

        .search-input {
          padding: 10px;
          width: 300px;
          border: 1px solid #ccc;
          border-radius: 4px 0 0 4px;
        }

        .search-button {
          padding: 10px;
          background-color: #FFD700;
          border: none;
          border-radius: 0 4px 4px 0;
          cursor: pointer;
        }

        .add-button-container {
          text-align: right;
          margin-bottom: 10px;
        }

        .add-button {
          background-color: #4CAF50;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
        }

        .khungct-table {
          width: 100%;
          border-collapse: collapse;
          background-color: #fdf2b2;
        }

        .khungct-table thead {
          background-color: yellow;
          font-weight: bold;
        }

        .khungct-table th, .khungct-table td {
          border: 1px solid #ccc;
          padding: 8px;
          text-align: center;
        }

        .khungct-table td {
          height: 30px;
        }

        .khungct-table img:hover {
          cursor: pointer;
        }
        .delete-button{
          background-color: rgb(255, 255, 255);
          color: black;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }
        .edit-button{
          background-color: rgb(255, 255, 255);
          color: black;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="profile">
            <img src="../static/image/user.svg" alt="Avatar">
            <h3>Admin <span>üë§</span></h3>
        </div>
        <nav class="menu">
            <a href="/admin/home">Trang ch·ªß</a>
            <a href="/admin/ctdt">Th√¥ng tin CTƒêT</a>
            <a class="active" href="#">Khung ch∆∞∆°ng tr√¨nh</a>
            <a href="#">Danh m·ª•c h·ªçc ph·∫ßn</a>
            <a href="#">ƒê·ªÅ c∆∞∆°ng chi ti·∫øt</a>
            <a href="#">K·∫ø ho·∫°ch d·∫°y h·ªçc</a>
            <a href="#">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="#">Gi·∫£ng vi√™n</a>
            <a href="#">M·∫´u in</a>
            <a href="#">Th·ªëng k√™</a>
            <a href="#">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </div>
    <main class="content">
        <h1>Danh s√°ch Khung theo Chuong tr√¨nh ƒë√†o t·∫°o</h1>

        <div class="top-bar">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Nh·∫≠p t√™n, b·∫≠c, khoa qu·∫£n l√Ω, ..."/>
                <button class="search-button" onclick="handleSearch()">üîç</button>
            </div>
            <div class="add-button-container">
                <button class="add-button" onclick="addKhungCT()">‚ûï Th√™m Khung CT</button>
                <button class="delete-button" onclick="deleteKhungCT()">üóëÔ∏è X√≥a Khung CT</button>
                <button class="edit-button" onclick="editKhungCT()">üìù S·ª≠a Khung CT</button>
            </div>
        </div>

        <table class="khungct-table">
            <thead>
            <tr>
                <th>Kh·ªëi ki·∫øn th·ª©c</th>
                <th>T√™n nh√≥m</th>
                <th>S·ªë t√≠n ch·ªâ b·∫Øt bu·ªôc</th>
                <th>S·ªë t√≠n ch·ªâ t·ª± ch·ªçn</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </main>
</div>
<script src="../static/jsApi/khungctJSAPI.js"></script>
<script>
    loadCT();

    function loadCT() {
      getAllKhungCT().then(data => {
        const table = document.querySelector('.khungct-table');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        data.forEach(item => {
          const row = document.createElement('tr');
          row.dataset.khungId = item.khungId;
          row.dataset.ctdtId = item.ctdtId;
          row.dataset.khoiKienThuc = item.khoiKienThuc;
          row.dataset.tenNhom = item.tenNhom;
          row.dataset.soTinChiBatBuoc = item.soTinChiBatBuoc;
          row.dataset.soTinChiTuChon = item.soTinChiTuChon;

          row.innerHTML = `
            <td>${item.khoiKienThuc}</td>
            <td>${item.tenNhom}</td>
            <td>${item.soTinChiBatBuoc}</td>
            <td>${item.soTinChiTuChon || ""}</td>
            <td style="white-space: nowrap;">
              <img src="../static/image/delete.svg" alt="X√≥a" onclick="deleteCT('${item.khungId}')">
              <img src="../static/image/edit.svg" alt="Ch·ªânh s·ª≠a" onclick="editCT(${item.khungId}, this)">
            </td>
          `;

          tbody.appendChild(row);
        });
      }).catch(error => {
        console.error('L·ªói khi t·∫£i d·ªØ li·ªáu CT:', error);
      });
    }

    function deleteKhungCT(id) {
    createConfirmPortal(id);
  }
  function createConfirmPortal(id) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.background = 'rgba(0, 0, 0, 0.5)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '9999';

    const modal = document.createElement('div');
    modal.style.background = 'white';
    modal.style.padding = '20px';
    modal.style.borderRadius = '8px';
    modal.style.textAlign = 'center';
    modal.innerHTML = `
    <p style="margin-bottom: 20px;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a Khung CT n√†y?</p>
    <button id="confirm-btn">X√≥a</button>
    <button id="cancel-btn">H·ªßy</button>
  `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const confirmBtn = modal.querySelector('#confirm-btn');
    const cancelBtn = modal.querySelector('#cancel-btn');

    [confirmBtn, cancelBtn].forEach(btn => {
      btn.style.padding = '10px 20px';
      btn.style.margin = '0 10px';
      btn.style.border = 'none';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      btn.style.fontSize = '14px';
      btn.style.transition = 'background-color 0.3s ease';
    });

    confirmBtn.style.backgroundColor = '#f44336';
    confirmBtn.style.color = 'white';

    cancelBtn.style.backgroundColor = '#e0e0e0';
    cancelBtn.style.color = '#333';

    confirmBtn.onmouseenter = () => confirmBtn.style.backgroundColor = '#d32f2f';
    confirmBtn.onmouseleave = () => confirmBtn.style.backgroundColor = '#f44336';

    cancelBtn.onmouseenter = () => cancelBtn.style.backgroundColor = '#ccc';
    cancelBtn.onmouseleave = () => cancelBtn.style.backgroundColor = '#e0e0e0';

    confirmBtn.onclick = () => {
      deleteKhungById(id)
              .then(data => {
                showBottomNotification('ƒê√£ x√≥a th√†nh c√¥ng!', true);
                loadCTDT();
              })
              .catch(err => {
                showBottomNotification('X√≥a th·∫•t b·∫°i!', false);
              });
      document.body.removeChild(overlay);
    };

    cancelBtn.onclick = () => {
      document.body.removeChild(overlay);
    };
  }
    function showBottomNotification(message, isSuccess) {
    const existingToasts = document.querySelectorAll('.custom-toast');
    const offset = existingToasts.length * 60;

    const notification = document.createElement('div');
    notification.classList.add('custom-toast');
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.bottom = `${20 + offset}px`;
    notification.style.right = '20px';
    notification.style.backgroundColor = isSuccess ? '#4caf50' : '#f44336';
    notification.style.color = 'white';
    notification.style.padding = '12px 24px';
    notification.style.borderRadius = '4px';
    notification.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
    notification.style.zIndex = '10000';
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.3s ease';

    document.body.appendChild(notification);

    requestAnimationFrame(() => {
      notification.style.opacity = '1';
    });

    setTimeout(() => {
      notification.style.opacity = '0';
      notification.addEventListener('transitionend', () => {
        notification.remove();
        const remainingToasts = document.querySelectorAll('.custom-toast');
        remainingToasts.forEach((toast, index) => {
          toast.style.bottom = `${20 + index * 60}px`;
        });
      });
    }, 3000);
  }
    function editKhungCT(id,button) {
    const row = button.closest('tr');

    const data = {
      khungId: id,
      khoiKienThuc: row.dataset.khoiKienThuc,
      tenNhom: row.dataset.tenNhom,
      soTinChiBatBuoc: row.dataset.soTinChiBatBuoc,
      soTinChiTuChon: row.dataset.soTinChiTuChon,
    };

    createFormEditPortal(data);
  }
    function createFormEditPortal(data) {
      createFormPortal('Ch·ªânh S·ª≠a Khung Ch∆∞∆°ng Tr√¨nh', data, (id,formData) => {
        return updateKhungById(id, formData)
                .then((response) => {
                  if(response.status==200){
                    showBottomNotification("S·ª≠a th√†nh c√¥ng!", true);
                    loadCT();
                  }else{
                    showBottomNotification(response.data.data.message, false);
                  }
                })
                .catch(() => {
                  showBottomNotification("S·ª≠a th·∫•t b·∫°i!", false);
                });
      });
    }


    function createFormPortal(title, initialData, onSubmit) {
      const overlay = document.createElement('div');
      overlay.style = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: flex;
      justify-content: center; align-items: center; z-index: 9999;
    `;

      const modal = document.createElement('div');
      modal.style = `
      background: white; padding: 20px; border-radius: 8px; width: 400px;
      max-height: 80vh; overflow-y: auto;
    `;

      const fields = [
        { name: 'khoiKienThuc', label: 'Kh·ªëi ki·∫øn th·ª©c' },
        { name: 'tenNhom', label: 'T√™n nh√≥m' },
        { name: 'soTinChiBatBuoc', label: 'S·ªë t√≠n ch·ªâ b·∫Øt bu·ªôc' },
        { name: 'soTinChiTuChon', label: 'S·ªë t√≠n ch·ªâ t·ª± ch·ªçn' },
      ];

      const form = document.createElement('form');
      fields.forEach(({ name, label, type = 'text' }) => {
        const input = document.createElement('input');
        input.type = type;
        input.step = 'any';
        input.name = name;
        input.required = true;
        input.placeholder = label;
        input.value = initialData?.[name] || '';
        input.style = `
          display: block;
          width: 100%;
          box-sizing: border-box;
          margin-bottom: 10px;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 4px;
        `;
        form.appendChild(input);
      });

      const submitBtn = document.createElement('button');
      submitBtn.textContent = 'L∆∞u';
      submitBtn.type = 'submit';
      submitBtn.style = 'margin-top: 10px; padding: 10px 20px;';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'H·ªßy';
      cancelBtn.type = 'button';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      cancelBtn.style = 'margin-top: 10px; margin-left: 10px; padding: 10px 20px;';

      form.appendChild(submitBtn);
      form.appendChild(cancelBtn);

      const heading = document.createElement('h3');
      heading.textContent = title;
      heading.style = 'margin-bottom: 20px; text-align: center;';

      modal.appendChild(heading);
      modal.appendChild(form);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      form.onsubmit = (e) => {
        e.preventDefault();
        const formData = {};
        fields.forEach(({name}) => {
          const val = form.elements[name].value;
          formData[name] = isNaN(val) ? val : parseFloat(val);
        });
        console.log(initialData)
        onSubmit(initialData.khungId,formData);
        document.body.removeChild(overlay);
      };
    }
    function addKhungCT() {
      createFormAddPortal()
    }
    function createFormAddPortal() {
      createFormPortal('Th√™m Khung Ch∆∞∆°ng Tr√¨nh', null, (formData) => {
        createKhung(formData)
                .then((response) => {
                  if(response.status==200){
                    showBottomNotification("Th√™m th√†nh c√¥ng!", true);
                    loadCT();
                  }else{
                    showBottomNotification(response.data.data.message, false);
                  }
                })
                .catch(() => {
                  showBottomNotification("Th√™m th·∫•t b·∫°i!", false);
                });
      });
    }
</script>
</body>
</html>