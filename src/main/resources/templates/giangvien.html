<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body{
          margin: 0;
        }
        .container {
          display: flex;
          height: 100vh;
        }

        .sidebar {
          width: 250px;
          background-color: #ffe55c;
          border-right: 2px solid #0097ff;
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        .profile {
          padding: 20px 0;
          text-align: center;
        }

        .profile img {
          border-radius: 50%;
          width: 80px;
          height: 80px;
        }

        .profile h3 {
          margin-top: 10px;
          font-size: 18px;
        }

        .menu {
          width: 100%;
        }

        .menu a {
          display: block;
          padding: 12px 20px;
          text-decoration: none;
          color: black;
          border-top: 1px solid #ddd;
        }

        .menu a.active {
          background-color: white;
          font-weight: bold;
        }

        .menu a:hover {
          background-color: #fdd835;
        }

        .content {
          flex: 1;
          background-color: #f7f7f7;
          padding: 40px;
          text-align: center;
        }
        /*content*/
        .top-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .search-container {
          display: flex;
          justify-content: center;
          align-items: center;
          margin: 20px 0;
        }

        .search-input {
          padding: 10px;
          width: 300px;
          border: 1px solid #ccc;
          border-radius: 4px 0 0 4px;
        }

        .search-button {
          padding: 10px;
          background-color: #FFD700;
          border: none;
          border-radius: 0 4px 4px 0;
          cursor: pointer;
        }

        .button-container {
          text-align: right;
          margin-bottom: 10px;
        }

        .import-button .export-button .add-button, .filter-button {
          width: 180px; 
          text-align: center;
        }

        .add-button {
          background-color: #4CAF50;
          color: white;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }
        .filter-button {
          background-color: rgb(255, 255, 255);
          color: black;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }

        .import-button {
          background-color: rgb(255, 255, 255);
          color: black;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }

        .export-button {
          background-color: rgb(255, 255, 255);
          color: black;
          padding: 10px 20px;
          border: none;
          border-radius: 6px;
          font-weight: bold;
          cursor: pointer;
          border: 2px solid black;
        }

        .gv-table {
          width: 100%;
          border-collapse: collapse;
          background-color: #fdf2b2;
        }

        .gv-table thead {
          background-color: yellow;
          font-weight: bold;
        }

        .gv-table th, .hp-table td {
          border: 1px solid #ccc;
          padding: 8px;
          text-align: center;
        }

        .gv-table td {
          height: 30px;
        }

        .gv-table img:hover {
          cursor: pointer;
        }
        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        }

        .modal-content {
          background: #fff;
          padding: 30px;
          border-radius: 10px;
          width: 400px;
          text-align: center;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .gv-table tbody tr.selected {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="profile">
            <img src="../static/image/giangvien.svg" alt="Avatar">
            <h3>Admin <span>üë§</span></h3>
        </div>
        <nav class="menu">
            <a href="/admin/home">Trang ch·ªß</a>
            <a href="/admin/ctdt">Th√¥ng tin CTƒêT</a>
            <a href="/admin/khung">Khung ch∆∞∆°ng tr√¨nh</a>
            <a href="#">Danh m·ª•c h·ªçc ph·∫ßn</a>
            <a href="#">ƒê·ªÅ c∆∞∆°ng chi ti·∫øt</a>
            <a href="#">K·∫ø ho·∫°ch d·∫°y h·ªçc</a>
            <a href="#">K·∫ø ho·∫°ch m·ªü nh√≥m</a>
            <a href="#">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a class="active" href="#">Gi·∫£ng vi√™n</a>
            <a href="#">M·∫´u in</a>
            <a href="#">Th·ªëng k√™</a>
            <a href="#">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </div>
    <main class="content">
        <h1>Danh s√°ch gi·∫£ng vi√™n</h1>
        <div class="top-bar">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Nh·∫≠p t√™n gi·∫£ng vi√™n ..."/>
                <button class="search-button" onclick="handleSearch()">üîç</button>
            </div>
            <div class="button-container">
                <button class="import-button">Import Excel üì•</button>
                <button class="export-button">Export Excel üì§</button>
                <button class="filter-button" onclick="showThongKeGV()">Th·ªëng k√™ üìä</button>
                <button class="add-button" onclick="addGV()">‚ûï Th√™m Gi·∫£ng Vi√™n</button>
            </div>
        </div>

        <table class="gv-table">
            <thead>
            <tr>
                <th>Gi·∫£ng vi√™n ID</th>
                <th>T√™n gi·∫£ng vi√™n</th>
                <th>Lo·∫°i gi·∫£ng vi√™n</th>
                <th>ƒê∆°n v·ªã</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>T√°c v·ª•</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="gv : ${giangviens}" th:data-userid="${gv.userId}">
                <td th:text="${gv.giangVienId}">Gi·∫£ng vi√™n ID</td>
                <td th:text="${gv.hoTen}">T√™n gi·∫£ng vi√™n</td>
                <td th:text="${gv.loaiGiangVien}">Lo·∫°i gi·∫£ng vi√™n</td>
                <td th:text="${gv.donVi}">ƒê∆°n v·ªã</td>
                <td th:text="${gv.email}">Email</td>
                <td th:text="${gv.soDienThoai}">S·ªë ƒëi·ªán tho·∫°i</td>
                <td>
                    <button onclick="editGV(this)">‚úèÔ∏è</button>
                    <button onclick="deleteGV(this)">üóëÔ∏è</button>
                </td>
            </tr>
            </tbody>
        </table>
        <!-- Modal th√™m gi·∫£ng vi√™n -->
        <div id="addGVModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Th√™m Gi·∫£ng Vi√™n</h3>
                <form id="addGVForm">
                    <label for="giangVienId">M√£ Gi·∫£ng Vi√™n (ID):</label>
                    <input type="text" id="giangVienId" name="giangVienId" required><br><br>

                    <label for="userId">T√†i kho·∫£n ng∆∞·ªùi d√πng:</label>
                    <select id="userId" name="userId" required>
                        <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                        <th:block th:each="user : ${users}">
                            <option th:value="${user.userId}"
                                    th:text="${user.userFullName} + ' (' + ${user.userEmail} + ')'">
                            </option>
                        </th:block>
                    </select><br><br>

                    <label for="hoTen">T√™n gi·∫£ng vi√™n:</label>
                    <input type="text" id="hoTen" name="hoTen" required><br><br>

                    <label for="loaiGiangVien">Lo·∫°i gi·∫£ng vi√™n:</label>
                    <input type="text" id="loaiGiangVien" name="loaiGiangVien" required><br><br>

                    <label for="donVi">ƒê∆°n v·ªã:</label>
                    <input type="text" id="donVi" name="donVi" required><br><br>

                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required><br><br>

                    <label for="soDienThoai">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="soDienThoai" name="soDienThoai" required><br><br>

                    <button type="submit">L∆∞u</button>
                    <button type="button" onclick="document.getElementById('addGVModal').style.display='none'">H·ªßy
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal ch·ªânh s·ª≠a gi·∫£ng vi√™n -->
        <div id="editGVModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Ch·ªânh s·ª≠a Gi·∫£ng Vi√™n</h3>
                <form id="editGVForm">
                    <label for="editGiangVienId">M√£ Gi·∫£ng Vi√™n (ID):</label>
                    <input type="text" id="editGiangVienId" name="giangVienId" readonly><br><br>

                    <label for="editUserId">T√†i kho·∫£n ng∆∞·ªùi d√πng:</label>
                    <select id="editUserId" name="userId" required>
                        <option value="">-- Ch·ªçn t√†i kho·∫£n --</option>
                        <th:block th:each="user : ${users}">
                            <option th:value="${user.userId}"
                                    th:text="${user.userFullName} + ' (' + ${user.userEmail} + ')'">
                            </option>
                        </th:block>
                    </select><br><br>

                    <label for="editHoTen">T√™n gi·∫£ng vi√™n:</label>
                    <input type="text" id="editHoTen" name="hoTen" required><br><br>

                    <label for="editLoaiGiangVien">Lo·∫°i gi·∫£ng vi√™n:</label>
                    <input type="text" id="editLoaiGiangVien" name="loaiGiangVien" required><br><br>

                    <label for="editDonVi">ƒê∆°n v·ªã:</label>
                    <input type="text" id="editDonVi" name="donVi" required><br><br>

                    <label for="editEmail">Email:</label>
                    <input type="email" id="editEmail" name="email" required><br><br>

                    <label for="editSoDienThoai">S·ªë ƒëi·ªán tho·∫°i:</label>
                    <input type="tel" id="editSoDienThoai" name="soDienThoai" required><br><br>

                    <button type="submit">C·∫≠p nh·∫≠t</button>
                    <button type="button" onclick="document.getElementById('editGVModal').style.display='none'">H·ªßy
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal th·ªëng k√™ -->
        <div id="statisticModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>Th·ªëng k√™ gi·∫£ng vi√™n theo lo·∫°i</h3>
                <canvas id="giangVienChart" width="400" height="300"></canvas>
                <br>
                <button onclick="closeStatisticModal()">ƒê√≥ng</button>
            </div>
        </div>



    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.querySelectorAll(".gv-table tbody tr").forEach(row => {
    row.addEventListener("click", function () {
        document.querySelectorAll(".gv-table tbody tr").forEach(r => r.classList.remove("selected"));
        this.classList.add("selected");
    });
});
    function loadGV() {
        fetch("/admin/giangvien/list")
            .then(res => res.json())
            .then(giangviens => {
                const tbody = document.querySelector(".gv-table tbody");
                tbody.innerHTML = "";

                giangviens.forEach(gv => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${gv.giangVienId}</td>
                        <td>${gv.hoTen}</td>
                        <td>${gv.loaiGiangVien}</td>
                        <td>${gv.donVi}</td>
                        <td>${gv.email}</td>
                        <td>${gv.soDienThoai}</td>
                        <td>
                            <button>‚úèÔ∏è</button>
                            <button>üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng:", err));
    }
    function addGV() {
        document.getElementById("addGVModal").style.display = "flex";
    }
    document.getElementById("addGVForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = {
            giangVienId: document.getElementById("giangVienId").value,
            userId: document.getElementById("userId").value,
            hoTen: document.getElementById("hoTen").value,
            loaiGiangVien: document.getElementById("loaiGiangVien").value,
            donVi: document.getElementById("donVi").value,
            email: document.getElementById("email").value,
            soDienThoai: document.getElementById("soDienThoai").value
        };

        fetch("/admin/giangvien/add", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(formData)
        })
        .then(res => {
            if (res.ok) {
                alert("Th√™m gi·∫£ng vi√™n th√†nh c√¥ng!");
                document.getElementById("addGVModal").style.display = "none";
                loadGV();
            } else {
                alert("L·ªói khi th√™m gi·∫£ng vi√™n!");
            }
        })
        .catch(err => {
            console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", err);
            alert("ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.");
        });
    });

    function fillEditFormFromRow(row) {
    try {
        const cells = row.getElementsByTagName("td");

        if (cells.length < 6) {
            alert("D·ªØ li·ªáu gi·∫£ng vi√™n kh√¥ng ƒë·∫ßy ƒë·ªß.");
            return;
        }

        const giangVienId = cells[0].innerText.trim();
        const hoTen = cells[1].innerText.trim();
        const loaiGiangVien = cells[2].innerText.trim();
        const donVi = cells[3].innerText.trim();
        const email = cells[4].innerText.trim();
        const soDienThoai = cells[5].innerText.trim();

        // L·∫•y userId t·ª´ attribute data-userid
        const userId = row.dataset.userid;

        document.getElementById("editGiangVienId").value = giangVienId;
        document.getElementById("editHoTen").value = hoTen;
        document.getElementById("editLoaiGiangVien").value = loaiGiangVien;
        document.getElementById("editDonVi").value = donVi;
        document.getElementById("editEmail").value = email;
        document.getElementById("editSoDienThoai").value = soDienThoai;

        // Set gi√° tr·ªã cho select userId
        document.getElementById("editUserId").value = userId;

        document.getElementById("editGVModal").style.display = "block";

    } catch (e) {
        console.error("L·ªói trong fillEditFormFromRow:", e);
        alert("Kh√¥ng th·ªÉ ƒëi·ªÅn d·ªØ li·ªáu v√†o form gi·∫£ng vi√™n.");
    }
}

    function editGV(button) {
    const row = button.closest("tr");
    fillEditFormFromRow(row);
    document.getElementById("editGVModal").style.display = "flex";
}
    // G·ª≠i form sau khi ch·ªânh s·ª≠a
    document.getElementById("editGVForm").addEventListener("submit", function(event) {
    event.preventDefault();

    const formData = new FormData(this);

    const giangVien = {
        giangVienId: formData.get("giangVienId"),
        userId: formData.get("userId"),
        hoTen: formData.get("hoTen"),
        loaiGiangVien: formData.get("loaiGiangVien"),
        donVi: formData.get("donVi"),
        email: formData.get("email"),
        soDienThoai: formData.get("soDienThoai")
    };

    fetch("/admin/giangvien/update", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(giangVien)
    })
    .then(response => {
        if (response.ok) {
            alert("C·∫≠p nh·∫≠t gi·∫£ng vi√™n th√†nh c√¥ng!");
            location.reload();
        } else {
            alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
        }
    })
    .catch(error => {
        console.error("L·ªói khi c·∫≠p nh·∫≠t gi·∫£ng vi√™n:", error);
        alert("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t!");
    });
});
    function deleteGV(button) {
        const row = button.closest("tr");
        const giangVienId = row.getAttribute("data-id") || row.cells[0].innerText.trim();

        // X√°c nh·∫≠n x√≥a ng∆∞·ªùi d√πng
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a gi·∫£ng vi√™n ID ${giangVienId}?`)) {
            fetch(`/admin/giangvien/delete/${giangVienId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert("X√≥a th√†nh c√¥ng!");
                    location.reload();
                } else {
                    alert("X√≥a th·∫•t b·∫°i!");
                }
            })
            .catch(error => {
                console.error("L·ªói khi x√≥a gi·∫£ng vi√™n:", error);
                alert("C√≥ l·ªói x·∫£y ra khi x√≥a!");
            });
        }
    }
    function handleSearch() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll(".gv-table tbody tr");

        rows.forEach(row => {
            const userName = row.cells[1].innerText.toLowerCase(); // C·ªôt ƒë·∫ßu ti√™n l√† t√™n ng∆∞·ªùi d√πng
            if (userName.includes(input)) {
                row.style.display = ""; // Hi·ªÉn th·ªã
            } else {
                row.style.display = "none"; // ·∫®n
            }
        });
    }
    function showThongKeGV() {
        fetch('/admin/giangvien/thongke')
          .then(response => response.json())
          .then(data => {
            const labels = data.labels;
            const counts = data.counts;

            const ctx = document.getElementById('giangVienChart').getContext('2d');

            // X√≥a chart c≈© n·∫øu c√≥
            if (window.myChart) {
              window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
              type: 'bar', // c√≥ th·ªÉ ƒë·ªïi th√†nh 'pie', 'doughnut', ...
              data: {
                labels: labels,
                datasets: [{
                  label: 'S·ªë l∆∞·ª£ng gi·∫£ng vi√™n',
                  data: counts,
                  backgroundColor: 'rgba(75, 192, 192, 0.5)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                scales: {
                  y: {
                    beginAtZero: true,
                    stepSize: 1
                  }
                }
              }
            });

            document.getElementById('statisticModal').style.display = 'flex';
          })
          .catch(error => {
            console.error('L·ªói khi l·∫•y d·ªØ li·ªáu th·ªëng k√™:', error);
            alert('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªëng k√™!');
          });
    }

  function closeStatisticModal() {
    document.getElementById('statisticModal').style.display = 'none';
  }


</script>
</body>
</html>
